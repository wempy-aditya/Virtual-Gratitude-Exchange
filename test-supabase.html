<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Connection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Koneksi Supabase</h1>
        
        <div id="configStatus"></div>
        <div id="connectionStatus"></div>
        <div id="tableStatus"></div>
        <div id="testResults"></div>

        <div style="margin-top: 20px;">
            <button onclick="testConnection()">Test Koneksi</button>
            <button onclick="testTables()">Test Tables</button>
            <button onclick="insertTestData()">Insert Test Data</button>
            <button onclick="showConfig()">Show Config</button>
        </div>

        <div id="debugInfo"></div>
    </div>

    <script src="config.js"></script>
    <script>
        let supabaseClient = null;

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showConfig() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <h3>Konfigurasi Supabase:</h3>
                <pre>
URL: ${window.SUPABASE_CONFIG?.url || 'TIDAK DITEMUKAN'}
API Key: ${window.SUPABASE_CONFIG?.apiKey ? window.SUPABASE_CONFIG.apiKey.substring(0, 20) + '...' : 'TIDAK DITEMUKAN'}
                </pre>
            `;
        }

        async function testConnection() {
            showStatus('connectionStatus', 'üîÑ Testing connection...', 'info');
            
            try {
                // Check config
                if (!window.SUPABASE_CONFIG) {
                    showStatus('configStatus', '‚ùå Config tidak ditemukan! Pastikan config.js sudah dimuat.', 'error');
                    return;
                }

                if (window.SUPABASE_CONFIG.url === 'YOUR_SUPABASE_URL' || 
                    window.SUPABASE_CONFIG.apiKey === 'YOUR_SUPABASE_ANON_KEY') {
                    showStatus('configStatus', '‚ö†Ô∏è Config masih default! Ganti dengan credentials Supabase Anda.', 'warning');
                    return;
                }

                showStatus('configStatus', '‚úÖ Config ditemukan dan sudah diubah', 'success');

                // Initialize Supabase client
                supabaseClient = supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.apiKey
                );

                // Test basic connection
                const { data, error } = await supabaseClient
                    .from('gratitude_messages')
                    .select('id')
                    .limit(1);

                if (error) {
                    if (error.message.includes('relation "public.gratitude_messages" does not exist')) {
                        showStatus('connectionStatus', '‚úÖ Koneksi berhasil, tapi tabel belum dibuat', 'warning');
                        showStatus('tableStatus', '‚ùå Tabel "gratitude_messages" belum ada. Jalankan SQL script untuk membuat tabel.', 'error');
                    } else {
                        throw error;
                    }
                } else {
                    showStatus('connectionStatus', '‚úÖ Koneksi berhasil!', 'success');
                    showStatus('tableStatus', '‚úÖ Tabel gratitude_messages ditemukan', 'success');
                }

            } catch (error) {
                showStatus('connectionStatus', `‚ùå Koneksi gagal: ${error.message}`, 'error');
                console.error('Connection error:', error);
            }
        }

        async function testTables() {
            if (!supabaseClient) {
                showStatus('testResults', '‚ùå Jalankan test koneksi terlebih dahulu', 'error');
                return;
            }

            showStatus('testResults', 'üîÑ Testing tables...', 'info');

            try {
                // Test gratitude_messages table
                const { data: messages, error: messagesError } = await supabaseClient
                    .from('gratitude_messages')
                    .select('*')
                    .limit(5);

                // Test app_stats table
                const { data: stats, error: statsError } = await supabaseClient
                    .from('app_stats')
                    .select('*')
                    .limit(1);

                let results = '<h3>üìä Hasil Test Tables:</h3>';
                
                if (messagesError) {
                    results += `<div class="status error">‚ùå gratitude_messages: ${messagesError.message}</div>`;
                } else {
                    results += `<div class="status success">‚úÖ gratitude_messages: ${messages.length} records ditemukan</div>`;
                }

                if (statsError) {
                    results += `<div class="status error">‚ùå app_stats: ${statsError.message}</div>`;
                } else {
                    results += `<div class="status success">‚úÖ app_stats: ${stats.length} records ditemukan</div>`;
                }

                if (messages && messages.length > 0) {
                    results += '<h4>Sample data:</h4><pre>' + JSON.stringify(messages[0], null, 2) + '</pre>';
                }

                showStatus('testResults', results, 'info');

            } catch (error) {
                showStatus('testResults', `‚ùå Error testing tables: ${error.message}`, 'error');
            }
        }

        async function insertTestData() {
            if (!supabaseClient) {
                showStatus('testResults', '‚ùå Jalankan test koneksi terlebih dahulu', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('gratitude_messages')
                    .insert([{
                        message: 'Test message dari connection tester',
                        category: 'general',
                        category_label: 'Apresiasi Umum',
                        country: 'Indonesia'
                    }])
                    .select();

                if (error) throw error;

                showStatus('testResults', `‚úÖ Test data berhasil diinsert! ID: ${data[0].id}`, 'success');
            } catch (error) {
                showStatus('testResults', `‚ùå Error inserting test data: ${error.message}`, 'error');
            }
        }

        // Auto-run config check on page load
        window.onload = function() {
            showConfig();
            if (window.SUPABASE_CONFIG && 
                window.SUPABASE_CONFIG.url !== 'YOUR_SUPABASE_URL' && 
                window.SUPABASE_CONFIG.apiKey !== 'YOUR_SUPABASE_ANON_KEY') {
                testConnection();
            }
        };
    </script>
</body>
</html>
